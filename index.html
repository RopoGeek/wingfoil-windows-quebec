<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wingfoil Windows – Québec Area</title>
<style>
  :root{
    --ok:#b7f3af;       /* green cell */
    --no:#ffd4d4;       /* red cell */
    --neutral:#eee;     /* grey cell */
    --grid-border:#ddd;
    --text:#222;
    --muted:#666;

    --tide-rise:#0a6;   /* dark green text bg for Rising */
    --tide-fall:#b00;   /* dark red text bg for Falling */
    --tide-slack:#888;  /* grey for Slack */
    --tide-unk:#aaa;    /* muted for Unknown */
  }
  body{font-family:system-ui,Segoe UI,Arial;margin:20px;color:var(--text)}
  header{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  h1{font-size:20px;margin:0}
  .pill{border:1px solid #aaa;border-radius:999px;padding:2px 8px;font-size:12px;color:#444}
  .muted{color:var(--muted);font-size:13px}

  .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:12px 0}
  .tabs{display:flex;gap:8px;margin:10px 0}
  .tab,.toggle{
    padding:6px 10px;border:1px solid #ccc;border-radius:999px;cursor:pointer;background:#fff
  }
  .tab.active{background:#f3fff6;border-color:#8fd4a8;color:#0a6}
  .toggle.active{background:#eef6ff;border-color:#76a7ff;color:#0a4}
  .legend{display:flex;gap:10px;align-items:center;margin:6px 0 14px;flex-wrap:wrap}
  .swatch{width:16px;height:12px;border:1px solid #bbb;display:inline-block;vertical-align:middle}
  .s-ok{background:var(--ok)} .s-no{background:var(--no)} .s-unk{background:var(--neutral)}
  .s-sep{width:30px;height:0;border-top:3px solid #999;margin-left:4px;margin-right:2px}

  /* Matrix */
  .matrix-wrap{overflow-x:auto;border:1px solid var(--grid-border);border-radius:10px}
  table{border-collapse:separate;border-spacing:0;width:max-content;min-width:100%}
  th,td{border-right:1px solid var(--grid-border);border-bottom:1px solid var(--grid-border)}
  th{position:sticky;top:0;background:#fafafa;font-weight:600;font-size:12px}
  th.day{min-width:80px;text-align:center}
  th.hour{position:sticky;left:0;background:#fafafa;font-weight:500;width:44px}
  th.tidecol{position:sticky;left:44px;background:#fafafa;font-weight:500;width:64px}
  td{height:18px;width:56px;padding:0}  /* narrow columns */
  .cell{height:18px;display:flex;align-items:center;justify-content:center}
  .hour-label{padding:0 6px;font-size:12px;color:#555}
  .footnote{margin-top:10px;font-size:12px;color:var(--muted)}
  /* arrow */
  .arrow{width:12px;height:12px;opacity:0.9}
  /* tide chips */
  .tide-chip{
    font-size:11px; line-height:1; padding:2px 6px; border-radius:6px; color:#fff; display:inline-block;
    min-width:56px; text-align:center;
  }
  .tide-rise{ background:var(--tide-rise); }
  .tide-fall{ background:var(--tide-fall); }
  .tide-slack{ background:#eee; color:#333; border:1px solid #ccc; }
  .tide-unk{ background:#f2f2f2; color:#888; border:1px solid #ddd; }
  /* separator rows when Rising↔Falling flips on baseline */
  tr.sep > th, tr.sep > td { border-top:3px solid #999 !important; }
</style>

<header>
  <h1>Wingfoil Windows – Québec Area</h1>
  <span class="pill">Local time (America/Toronto)</span>
</header>
<p class="muted">
  Flip between spots below. Use the toggle to show <b>Daylight (06–21)</b> or <b>All hours (00–23)</b>.
  Days are columns, hours are rows. Coloring is based on <b>gust speed</b> meeting your rules.
  Hover a cell to see <b>gust</b>, <b>avg</b>, cardinal & tide.
</p>

<div class="controls">
  <div class="tabs" id="tabs"></div>
  <div class="viewtoggles">
    <button class="toggle active" id="tgl-daylight">Daylight</button>
    <button class="toggle" id="tgl-all">All hours</button>
  </div>
</div>

<div class="legend">
  <span class="swatch s-ok"></span> Go (gust meets rule) &nbsp;
  <span class="swatch s-no"></span> Not meeting rules &nbsp;
  <span class="swatch s-unk"></span> Missing data &nbsp; | &nbsp;
  <span class="s-sep"></span> Rising ↔ Falling boundary (baseline)
</div>

<div id="matrices"></div>

<p class="footnote">
  Rules:
  <b>Baie de Beauport</b> ≥10 kn gust (any direction);
  <b>Ste-Anne-de-Beaupré</b> SW 200–250° & rising tide & ≥10 kn gust;
  <b>St-Jean, Île d’Orléans</b> NE 30–70° & falling tide & ≥10 kn gust.
  Arrow points <b>from</b> the wind’s source (based on mean wind direction).
</p>

<script>
(async function(){
  // Default view mode
  let VIEW = 'daylight'; // 'daylight' | 'all'
  const HOUR_RANGE = { daylight:[6,21], all:[0,23] };

  // Load data (cache-busted)
  let data;
  try{
    data = await fetch('forecast.json?v=' + Date.now(), {cache:'no-store'}).then(r=>r.json());
  }catch(e){
    document.body.insertAdjacentHTML('beforeend',
      '<p style="color:#b00">Could not load forecast.json. Run the “Update forecast” workflow once (Actions tab), or wait for it to run automatically.</p>');
    return;
  }
  const hours = data.hours || [];
  if (!hours.length){
    document.body.insertAdjacentHTML('beforeend',
      '<p class="muted">No data yet. Run the “Update forecast” workflow, then refresh.</p>');
    return;
  }

  // Helpers
  const toLocal = s => new Date(s);
  const dayKey = d => d.toLocaleDateString('en-CA', { timeZone: 'America/Toronto' });
  const dayLabel = d => d.toLocaleDateString('en-CA', { weekday:'short', month:'short', day:'2-digit', timeZone:'America/Toronto' });
  const hourStr = d => d.toLocaleString('en-CA',{ hour:'2-digit', hour12:false, timeZone:'America/Toronto' });

  function degToCardinal(deg){
    if (deg==null || isNaN(deg)) return '';
    const dirs = ['N','NE','E','SE','S','SW','W','NW'];
    const ix = Math.round(((deg%360)/45)) % 8;
    return dirs[ix];
  }
  // Arrow shows "from" direction; rotate an up arrow by (180 + deg).
  function arrowSVG(deg){
    if (deg==null || isNaN(deg)) return '';
    const rot = (180 + Number(deg)) % 360;
    return `<svg class="arrow" viewBox="0 0 24 24" style="transform:rotate(${rot}deg)">
      <path d="M12 4 L8 10 H11 V20 H13 V10 H16 Z" fill="currentColor"></path>
    </svg>`;
  }

  // Group ALL rows by day for quick access
  const byDayAll = new Map(); // day -> array of rows (full objects with all 3 spots)
  for(const row of hours){
    const t = toLocal(row.time);
    const k = dayKey(t);
    if(!byDayAll.has(k)) byDayAll.set(k, []);
    byDayAll.get(k).push(row);
  }
  for(const arr of byDayAll.values()){
    arr.sort((a,b)=> new Date(a.time)-new Date(b.time));
  }
  const dayOrder = Array.from(byDayAll.keys()).sort((a,b)=> new Date(a)-new Date(b));

  // Build a quick lookup map for baseline (Beauport) tide per day/hour
  const baselineTide = {}; // { dayKey: { "06": "rising", ... } }
  dayOrder.forEach(k=>{
    baselineTide[k] = {};
    const arr = byDayAll.get(k) || [];
    for(const row of arr){
      const h = hourStr(new Date(row.time));
      const tide = row.beauport ? (row.beauport.tide ?? 'unknown') : 'unknown';
      baselineTide[k][h] = tide;
    }
  });

  const spots = [
    {key:'beauport', label:'Baie de Beauport'},
    {key:'ste_anne', label:'Ste-Anne-de-Beaupré'},
    {key:'st_jean', label:'St-Jean, Île d’Orléans'},
  ];

  const tabBar = document.getElementById('tabs');
  const matrices = document.getElementById('matrices');

  // Build tabs
  spots.forEach((s,i)=>{
    const tab = document.createElement('button');
    tab.className = 'tab' + (i===0?' active':'');
    tab.textContent = s.label;
    tab.dataset.target = s.key;
    tabBar.appendChild(tab);
  });

  function tideChipHTML(state){
    const s = (state||'unknown').toLowerCase();
    if (s==='rising')  return `<span class="tide-chip tide-rise">Rising</span>`;
    if (s==='falling') return `<span class="tide-chip tide-fall">Falling</span>`;
    if (s==='slack')   return `<span class="tide-chip tide-slack">Slack</span>`;
    return `<span class="tide-chip tide-unk">Unknown</span>`;
  }

  function buildMatrix(spotKey, mode){
    const [HSTART, HEND] = HOUR_RANGE[mode];

    const container = document.createElement('div');
    container.className = 'matrix-wrap';
    const tbl = document.createElement('table');

    // Header
    const thead = document.createElement('thead');
    const htr = document.createElement('tr');

    const corner = document.createElement('th');
    corner.className = 'hour';
    corner.textContent = 'Hour';
    htr.appendChild(corner);

    const hTide = document.createElement('th');
    hTide.className = 'tidecol';
    hTide.textContent = 'Tide';
    htr.appendChild(hTide);

    dayOrder.forEach(dk=>{
      const th = document.createElement('th');
      th.className = 'day';
      const dt = new Date(dk + 'T00:00:00-04:00');
      th.innerHTML = `<div class="day-head"><div class="date">${dayLabel(dt)}</div></div>`;
      htr.appendChild(th);
    });
    thead.appendChild(htr);
    tbl.appendChild(thead);

    // Build map[day][hour] = row[spotKey]
    const map = {};
    dayOrder.forEach(k=>{
      map[k] = {};
      const arr = byDayAll.get(k) || [];
      arr.forEach(row=>{
        const h = hourStr(new Date(row.time));
        map[k][h] = row[spotKey] || {};
      });
    });

    const tbody = document.createElement('tbody');
    let prevBaseline = null;

    for(let hour=HSTART; hour<=HEND; hour++){
      const hrStr = hour.toString().padStart(2,'0');
      const tr = document.createElement('tr');

      // Hour header
      const th = document.createElement('th');
      th.className = 'hour';
      th.innerHTML = `<span class="hour-label">${hrStr}</span>`;
      tr.appendChild(th);

      // Tide column (baseline = Beauport)
      // Use the FIRST day’s baseline for the separator check; for display we show "--" if mixed across days.
      // But for quick grasp, we show the baseline of the FIRST day column.
      let firstDayTide = baselineTide[dayOrder[0]] ? (baselineTide[dayOrder[0]][hrStr] || 'unknown') : 'unknown';
      const tdTide = document.createElement('th');
      tdTide.className = 'tidecol';
      tdTide.innerHTML = tideChipHTML(firstDayTide);
      tr.appendChild(tdTide);

      // Separator logic: add thick line when baseline flips Rising↔Falling from previous hour
      const flip = (a,b) => {
        const A=a&&a.toLowerCase(), B=b&&b.toLowerCase();
        return (A==='rising' && B==='falling') || (A==='falling' && B==='rising');
      };
      if (prevBaseline!==null && flip(prevBaseline, firstDayTide)){
        tr.classList.add('sep');
      }
      prevBaseline = firstDayTide;

      // Data cells
      dayOrder.forEach(dk=>{
        const obj = (map[dk] && map[dk][hrStr]) ? map[dk][hrStr] : {};
        const go = obj.go ? (obj.go.beauport ?? obj.go.ste_anne ?? obj.go.st_jean) : false;

        let bg = 'var(--neutral)';
        if (obj.wind_kn == null) {
          bg = 'var(--neutral)';
        } else if (go) {
          bg = 'var(--ok)';
        } else {
          bg = 'var(--no)';
        }

        const tide = (obj.tide ?? 'unknown');
        const gust = (obj.wind_kn == null ? '-' : obj.wind_kn);           // gusts in kn
        const avg  = (obj.wind_avg_kn == null ? '' : `, avg ${obj.wind_avg_kn} kn`);
        const deg  = obj.dir_deg;
        const card = degToCardinal(deg);
        const tip = `${dk} ${hrStr}:00 — gust ${gust} kn${avg}${card?` (${card}${deg!=null?` ${deg}°`:''})`:''} • tide: ${tide}`;

        const td = document.createElement('td');
        td.innerHTML = `<div class="cell" title="${tip}">${deg!=null ? arrowSVG(deg) : ''}</div>`;
        td.querySelector('.cell').style.background = bg;
        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    }

    tbl.appendChild(tbody);
    container.appendChild(tbl);
    return container;
  }

  function render(mode){
    matrices.innerHTML = '';
    const views = {};
    const spots = [
      {key:'beauport', label:'Baie de Beauport'},
      {key:'ste_anne', label:'Ste-Anne-de-Beaupré'},
      {key:'st_jean', label:'St-Jean, Île d’Orléans'},
    ];
    spots.forEach((s,i)=>{
      const v = buildMatrix(s.key, mode);
      v.style.display = i===0 ? 'block':'none';
      v.id = 'view-'+s.key;
      matrices.appendChild(v);
      views[s.key] = v;
    });

    // Tab switching
    tabBar.onclick = (e)=>{
      const btn = e.target.closest('.tab');
      if(!btn) return;
      [...tabBar.children].forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const target = btn.dataset.target;
      Object.values(views).forEach(v=>v.style.display='none');
      views[target].style.display = 'block';
    };
  }

  // Initial render
  render(VIEW);

  // Toggle listeners
  const btnDay = document.getElementById('tgl-daylight');
  const btnAll = document.getElementById('tgl-all');
  function setToggle(active){
    btnDay.classList.toggle('active', active==='daylight');
    btnAll.classList.toggle('active', active==='all');
  }
  btnDay.onclick = ()=>{ VIEW='daylight'; setToggle(VIEW); render(VIEW); };
  btnAll.onclick = ()=>{ VIEW='all'; setToggle(VIEW); render(VIEW); };

})();
</script>
</html>
