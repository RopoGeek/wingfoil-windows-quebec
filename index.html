<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wingfoil Windows – Québec Area</title>
<style>
  :root{
    --ok:#b7f3af;       /* green */
    --no:#ffd4d4;       /* red */
    --neutral:#eee;     /* grey */
    --grid-border:#ddd;
    --text:#222;
    --muted:#666;
  }
  body{font-family:system-ui,Segoe UI,Arial;margin:20px;color:var(--text)}
  header{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  h1{font-size:20px;margin:0}
  .pill{border:1px solid #aaa;border-radius:999px;padding:2px 8px;font-size:12px;color:#444}
  .muted{color:var(--muted);font-size:13px}
  .tabs{display:flex;gap:8px;margin:14px 0}
  .tab{padding:6px 10px;border:1px solid #ccc;border-radius:999px;cursor:pointer}
  .tab.active{background:#f3fff6;border-color:#8fd4a8;color:#0a6}
  .legend{display:flex;gap:10px;align-items:center;margin:6px 0 14px}
  .swatch{width:16px;height:12px;border:1px solid #bbb;display:inline-block;vertical-align:middle}
  .s-ok{background:var(--ok)} .s-no{background:var(--no)} .s-unk{background:var(--neutral)}

  /* Matrix */
  .matrix-wrap{overflow-x:auto;border:1px solid var(--grid-border);border-radius:10px}
  table{border-collapse:separate;border-spacing:0;width:max-content;min-width:100%}
  th,td{border-right:1px solid var(--grid-border);border-bottom:1px solid var(--grid-border)}
  th{position:sticky;top:0;background:#fafafa;font-weight:600;font-size:12px}
  th.day{min-width:80px;text-align:center}
  th.hour{position:sticky;left:0;background:#fafafa;font-weight:500;width:44px}
  td{height:18px;width:56px;padding:0}           /* ~less than half the previous width (120px) */
  .cell{height:18px;display:flex;align-items:center;justify-content:center}
  .hour-label{padding:0 6px;font-size:12px;color:#555}
  .footnote{margin-top:10px;font-size:12px;color:var(--muted)}
  /* Tiny arrow svg */
  .arrow{width:12px;height:12px;opacity:0.9}
</style>

<header>
  <h1>Wingfoil Windows – Québec Area</h1>
  <span class="pill">Local time (America/Toronto)</span>
</header>
<p class="muted">
  Flip between spots below. Each grid shows <b>hours vertically (06–21)</b> and <b>days horizontally</b>.
  Cells turn green only when your rules are met. Hover a cell to see wind (kn), cardinal & tide.
</p>

<div class="tabs" id="tabs"></div>

<div class="legend">
  <span class="swatch s-ok"></span> Go &nbsp;
  <span class="swatch s-no"></span> Not meeting rules &nbsp;
  <span class="swatch s-unk"></span> Missing data
</div>

<div id="matrices"></div>

<p class="footnote">
  Rules:
  <b>Baie de Beauport</b> ≥10 kn (any direction);
  <b>Ste-Anne-de-Beaupré</b> SW 200–250° & rising tide & ≥12 kn;
  <b>St-Jean, Île d’Orléans</b> NE 30–70° & falling tide & ≥12 kn.
  Arrows point <b>from</b> the wind’s source (meteorological direction).
</p>

<script>
(async function(){
  // Config: show daylight hours only
  const HOUR_START = 6;   // inclusive
  const HOUR_END   = 21;  // inclusive

  // Load data
  let data;
  try{
    data = await fetch('forecast.json',{cache:'no-store'}).then(r=>r.json());
  }catch(e){
    document.body.insertAdjacentHTML('beforeend',
      '<p style="color:#b00">Could not load forecast.json. Run the “Update forecast” workflow once (Actions tab), or wait for it to run automatically.</p>');
    return;
  }

  const hours = data.hours || [];
  if (!hours.length){
    document.body.insertAdjacentHTML('beforeend',
      '<p class="muted">No data yet. Run the “Update forecast” workflow, then refresh.</p>');
    return;
  }

  // Helpers
  const toLocal = s => new Date(s);
  const dayKey = d => d.toLocaleDateString('en-CA', { timeZone: 'America/Toronto' });
  const dayLabel = d => d.toLocaleDateString('en-CA', { weekday:'short', month:'short', day:'2-digit', timeZone:'America/Toronto' });
  const hourStr = d => d.toLocaleString('en-CA',{ hour:'2-digit', hour12:false, timeZone:'America/Toronto' });

  function degToCardinal(deg){
    if (deg==null || isNaN(deg)) return '';
    const dirs = ['N','NE','E','SE','S','SW','W','NW'];
    const ix = Math.round(((deg%360)/45)) % 8;
    return dirs[ix];
  }
  // Build a tiny SVG arrow pointing UP by default; rotate to show "from" direction.
  function arrowSVG(deg){
    if (deg==null || isNaN(deg)) return '';
    // For "from" direction: rotate an up arrow by (180 + deg)
    const rot = (180 + Number(deg)) % 360;
    return `
      <svg class="arrow" viewBox="0 0 24 24" style="transform:rotate(${rot}deg)">
        <path d="M12 4 L8 10 H11 V20 H13 V10 H16 Z" fill="currentColor"></path>
      </svg>`;
  }

  // Group by local day key
  const byDay = new Map();
  for(const row of hours){
    const t = toLocal(row.time);
    const k = dayKey(t);
    if(!byDay.has(k)) byDay.set(k, []);
    byDay.get(k).push(row);
  }
  for(const arr of byDay.values()){
    arr.sort((a,b)=> new Date(a.time)-new Date(b.time));
  }

  const spots = [
    {key:'beauport', label:'Baie de Beauport'},
    {key:'ste_anne', label:'Ste-Anne-de-Beaupré'},
    {key:'st_jean', label:'St-Jean, Île d’Orléans'},
  ];

  const tabBar = document.getElementById('tabs');
  const matrices = document.getElementById('matrices');

  spots.forEach((s,i)=>{
    const tab = document.createElement('button');
    tab.className = 'tab' + (i===0?' active':'');
    tab.textContent = s.label;
    tab.dataset.target = s.key;
    tabBar.appendChild(tab);
  });

  function buildMatrix(spotKey){
    const container = document.createElement('div');
    container.className = 'matrix-wrap';
    const tbl = document.createElement('table');

    // Header row
    const thead = document.createElement('thead');
    const htr = document.createElement('tr');

    const corner = document.createElement('th');
    corner.className = 'hour';
    corner.textContent = 'Hour';
    htr.appendChild(corner);

    const dayOrder = Array.from(byDay.keys()).sort((a,b)=> new Date(a)-new Date(b));
    dayOrder.forEach(dk=>{
      const th = document.createElement('th');
      th.className = 'day';
      const dt = new Date(dk + 'T00:00:00-04:00');
      th.innerHTML = `<div class="day-head"><div class="date">${dayLabel(dt)}</div></div>`;
      htr.appendChild(th);
    });
    thead.appendChild(htr);
    tbl.appendChild(thead);

    // Build a quick access map[day][hour] = row[spotKey]
    const map = {};
    dayOrder.forEach(k=>{
      map[k] = {};
      const arr = byDay.get(k) || [];
      arr.forEach(row=>{
        const h = hourStr(new Date(row.time));
        map[k][h] = row[spotKey] || {};
      });
    });

    const tbody = document.createElement('tbody');
    // Only daylight hours
    for(let hour=HOUR_START; hour<=HOUR_END; hour++){
      const hrStr = hour.toString().padStart(2,'0');
      const tr = document.createElement('tr');

      const th = document.createElement('th');
      th.className = 'hour';
      th.innerHTML = `<span class="hour-label">${hrStr}</span>`;
      tr.appendChild(th);

      dayOrder.forEach(dk=>{
        const obj = map[dk][hrStr] || {};
        const go = obj.go ? (obj.go.beauport ?? obj.go.ste_anne ?? obj.go.st_jean) : false;

        let bg = 'var(--neutral)';
        if (obj.wind_kn == null) {
          bg = 'var(--neutral)';
        } else if (go) {
          bg = 'var(--ok)';
        } else {
          bg = 'var(--no)';
        }

        const tide = (obj.tide ?? 'unknown');
        const w = (obj.wind_kn == null ? '-' : obj.wind_kn + ' kn');
        const deg = obj.dir_deg;
        const card = degToCardinal(deg);
        const tip = `${dk} ${hrStr}:00 — ${w}${card?` (${card} ${deg??''}°)`:''} • tide: ${tide}`;

        const td = document.createElement('td');
        td.innerHTML = `<div class="cell" title="${tip}">${deg!=null ? arrowSVG(deg) : ''}</div>`;
        td.querySelector('.cell').style.background = bg;
        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    }

    tbl.appendChild(tbody);
    container.appendChild(tbl);
    return container;
  }

  // Render views
  const views = {};
  spots.forEach((s,i)=>{
    const v = buildMatrix(s.key);
    v.style.display = i===0 ? 'block':'none';
    v.id = 'view-'+s.key;
    matrices.appendChild(v);
    views[s.key] = v;
  });

  // Tab switching
  tabBar.addEventListener('click', (e)=>{
    const btn = e.target.closest('.tab');
    if(!btn) return;
    [...tabBar.children].forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const target = btn.dataset.target;
    Object.values(views).forEach(v=>v.style.display='none');
    views[target].style.display = 'block';
  });
})();
</script>
</html>
